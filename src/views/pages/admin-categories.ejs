<div class="mx-auto flex w-full max-w-screen-lg flex-col gap-4">
  <h1 class="text-2xl font-semibold">Manage Categories</h1>

  <% adminCategories.forEach(cat => { %>
  <details cat-id="<%= cat._id %>" class="rounded-lg border-2 border-zinc-400">
    <summary
      class="flex w-full items-center justify-between px-4 py-2 marker:m-0 marker:appearance-none marker:p-0"
    >
      <h2 id="cat-name-<%= cat._id %>" class="font-semibold inline-block"><%= cat.name %></h2>
      <div class="flex flex-row items-center gap-px">
        <button
          id="edit-btn-cat-<%= cat._id %>"
          class="flex items-center justify-center p-2 duration-200 hover:bg-zinc-200"
          onclick="startEditing('<%= cat._id %>', 'cat')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 -960 960 960"
            class="size-6"
            aria-label="Edit"
          >
            <path
              d="M206.22-206.78h57.56l352.57-352.57-56.44-57-353.69 353.7v55.87Zm-52.44 106q-22.08 0-37.54-15.46t-15.46-37.54v-109.44q0-21.08 7.98-40.39 7.98-19.3 22.94-34.26l495.95-495.52q13.13-12.7 29.33-19.26 16.19-6.57 33.89-6.57 17.13 0 33.83 6.57 16.69 6.56 29.95 19.69l79.31 78.61q13.13 12.7 19.48 29.68 6.34 16.97 6.34 34.24 0 17.69-6.34 34.17-6.35 16.48-19.48 29.61L339-131.7q-14.96 14.96-34.26 22.94-19.3 7.98-40.39 7.98H153.78Zm593.78-589.65L691-747.56l56.56 57.13ZM587.91-587.91l-28-28.44 56.44 57-28.44-28.56Z"
            />
          </svg>
        </button>
        
        <div id="edit-form-cat-<%= cat._id %>" class="hidden">
          <input
            type="text"
            id="edit-input-cat-<%= cat._id %>"
            class="border p-2"
            value="<%= cat.name %>"
          />
          <button
            onclick="confirmEdit('<%= cat._id %>','cat')"
            class="p-2 bg-blue-500 text-white rounded"
          >
            Confirm
          </button>
          <button
            onclick="cancelEdit('<%= cat._id %>','cat')"
            class="p-2 bg-gray-300 text-black rounded"
          >
            Cancel
          </button>
        </div>

        <button
                id="add-btn-cat-<%= cat._id %>"
                class="flex items-center justify-center p-2 duration-200 hover:bg-zinc-200 "
                onclick="showAddInputForm('<%= cat._id %>')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 -960 960 960"
            class="size-6"
            aria-label="Add"
          >
            <path
              d="M427-427H233.78q-22.08 0-37.54-15.46-15.46-15.45-15.46-37.54t15.46-37.54Q211.7-533 233.78-533H427v-193.22q0-22.08 15.46-37.54 15.45-15.46 37.54-15.46t37.54 15.46Q533-748.3 533-726.22V-533h193.22q22.08 0 37.54 15.46 15.46 15.45 15.46 37.54t-15.46 37.54Q748.3-427 726.22-427H533v193.22q0 22.08-15.46 37.54-15.45 15.46-37.54 15.46t-37.54-15.46Q427-211.7 427-233.78V-427Z"
            />
          </svg>
        </button>

        <button
          class="flex items-center justify-center p-2 duration-200 hover:bg-zinc-200"
          onclick="confirmDelete('<%= cat._id %>')"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 -960 960 960"
            class="size-6"
            aria-label="Delete"
          >
            <path
              d="M273.78-100.78q-44.3 0-75.15-30.85-30.85-30.85-30.85-75.15v-507q-22.09 0-37.54-15.46-15.46-15.46-15.46-37.54 0-22.09 15.46-37.55 15.45-15.45 37.54-15.45H347q0-22.09 15.46-37.55 15.45-15.45 37.54-15.45h158.87q22.09 0 37.54 15.45 15.46 15.46 15.46 37.55h180.35q22.09 0 37.54 15.45 15.46 15.46 15.46 37.55 0 22.08-15.46 37.54-15.45 15.46-37.54 15.46v507q0 44.3-30.85 75.15-30.85 30.85-75.15 30.85H273.78Zm412.44-613H273.78v507h412.44v-507ZM396.61-280.57q19.26 0 32.74-13.47 13.48-13.48 13.48-32.74v-267.57q0-19.26-13.48-32.74t-32.74-13.48q-19.26 0-33.02 13.48-13.76 13.48-13.76 32.74v267.57q0 19.26 13.76 32.74 13.76 13.47 33.02 13.47Zm167.35 0q19.26 0 32.74-13.47 13.47-13.48 13.47-32.74v-267.57q0-19.26-13.47-32.74-13.48-13.48-32.74-13.48t-33.03 13.48q-13.76 13.48-13.76 32.74v267.57q0 19.26 13.76 32.74 13.77 13.47 33.03 13.47ZM273.78-713.78v507-507Z"
            />
          </svg>
        </button>

        <div
          id="delete-modal"
          style="
            display: none !important; 
            position: fixed; 
            inset: 0; 
            background-color: rgba(0, 0, 0, 0.5); 
            z-index: 1000; 
            display: flex; 
            justify-content: center; 
            align-items: center;"
          class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50"
        >
          <div class="model-content">
            <div class="bg-white p-6 rounded-lg shadow-lg text-center">
              <p class="mb-4 text-lg font-semibold">Bạn chắc chắn muốn xóa category này chứ?</p>
              <div class="flex justify-center gap-4">
              <button
                id="cancel-btn"
                class="px-4 py-2 bg-gray-300 text-black rounded"
                onclick="closeModal()"
              >
                Cancel
              </button>
              <button
                id="confirm-btn"
                class="px-4 py-2 bg-red-500 text-white rounded"
              >
                Confirm
              </button>
            </div>
          </div>
        </div>
      </div>
    </summary>

    <% if (cat.children.length == 0) { %>
    <p class="p-4 text-zinc-600">No sub-categories.</p>
    <% } else { %>
    <ul class="flex w-full flex-col gap-2 p-4">
      <% cat.children.forEach(sub => { %>
      <li class="flex flex-row items-center justify-between">
        <h3 id="sub-name-<%= sub._id %>" class="font-semibold inline-block"><%= sub.name %></h3>
        <div>
        <div class="flex flex-row items-center gap-2">
          <button
          id="edit-btn-sub-<%= sub._id %>"
          class="p-2 duration-200 hover:bg-zinc-200"
          onclick="startEditing('<%= sub._id %>', 'sub')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 -960 960 960"
              class="size-6"
              aria-label="Edit"
            >
              <path
                d="M206.22-206.78h57.56l352.57-352.57-56.44-57-353.69 353.7v55.87Zm-52.44 106q-22.08 0-37.54-15.46t-15.46-37.54v-109.44q0-21.08 7.98-40.39 7.98-19.3 22.94-34.26l495.95-495.52q13.13-12.7 29.33-19.26 16.19-6.57 33.89-6.57 17.13 0 33.83 6.57 16.69 6.56 29.95 19.69l79.31 78.61q13.13 12.7 19.48 29.68 6.34 16.97 6.34 34.24 0 17.69-6.34 34.17-6.35 16.48-19.48 29.61L339-131.7q-14.96 14.96-34.26 22.94-19.3 7.98-40.39 7.98H153.78Zm593.78-589.65L691-747.56l56.56 57.13ZM587.91-587.91l-28-28.44 56.44 57-28.44-28.56Z"
              />
            </svg>
          </button>
          <div id="edit-form-sub-<%= sub._id %>" class="hidden">
            <input
              type="text"
              id="edit-input-sub-<%= sub._id %>"
              class="border p-2"
              value="<%= sub.name %>"
            />
            <button
              onclick="confirmEdit('<%= sub._id %>', 'sub')"
              class="p-2 bg-blue-500 text-white rounded"
            >
              Confirm
            </button>
            <button
              onclick="cancelEdit('<%= sub._id %>', 'sub')"
              class="p-2 bg-gray-300 text-black rounded"
            >
              Cancel
            </button>
          </div>
          
          <a
            href="./delete/<%= cat._id %>"
            class="flex items-center justify-center p-2 duration-200 hover:bg-zinc-200"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 -960 960 960"
              class="size-6"
              aria-label="Delete"
            >
              <path
                d="M273.78-100.78q-44.3 0-75.15-30.85-30.85-30.85-30.85-75.15v-507q-22.09 0-37.54-15.46-15.46-15.46-15.46-37.54 0-22.09 15.46-37.55 15.45-15.45 37.54-15.45H347q0-22.09 15.46-37.55 15.45-15.45 37.54-15.45h158.87q22.09 0 37.54 15.45 15.46 15.46 15.46 37.55h180.35q22.09 0 37.54 15.45 15.46 15.46 15.46 37.55 0 22.08-15.46 37.54-15.45 15.46-37.54 15.46v507q0 44.3-30.85 75.15-30.85 30.85-75.15 30.85H273.78Zm412.44-613H273.78v507h412.44v-507ZM396.61-280.57q19.26 0 32.74-13.47 13.48-13.48 13.48-32.74v-267.57q0-19.26-13.48-32.74t-32.74-13.48q-19.26 0-33.02 13.48-13.76 13.48-13.76 32.74v267.57q0 19.26 13.76 32.74 13.76 13.47 33.02 13.47Zm167.35 0q19.26 0 32.74-13.47 13.47-13.48 13.47-32.74v-267.57q0-19.26-13.47-32.74-13.48-13.48-32.74-13.48t-33.03 13.48q-13.76 13.48-13.76 32.74v267.57q0 19.26 13.76 32.74 13.77 13.47 33.03 13.47ZM273.78-713.78v507-507Z"
              />
            </svg>
          </a>
        </div>
      </li>
      <% }) %>
    </ul>
    <% } %>
    <div id="add-form-cat-<%= cat._id %>" class="hidden p-4">
      <input
          type="text"
          id="add-input-cat-<%= cat._id %>"
          class="border p-2 w-full"
          placeholder="Enter new sub-category"
      />
      <div class="flex gap-2 mt-2">
          <button
              onclick="confirmAdd('<%= cat._id %>')"
              class="p-2 bg-blue-500 text-white rounded"
          >
              Confirm
          </button>
          <button
              onclick="cancelAdd('<%= cat._id %>')"
              class="p-2 bg-gray-300 text-black rounded"
          >
              Cancel
          </button>
      </div>
  </div>
  </details>
  <% }) %>
</div>

<script>
  function startEditing(entityId, entityType) {
  // Hide the text and edit button
  document.getElementById(`${entityType}-name-${entityId}`).style.display = "none";
  document.getElementById(`edit-btn-${entityType}-${entityId}`).style.display = "none";

  // Show the input form
  document.getElementById(`edit-form-${entityType}-${entityId}`).classList.remove("hidden");
}

function confirmEdit(entityId, entityType) {
  // Get the new value from the input field
  const newValue = document.getElementById(`edit-input-${entityType}-${entityId}`).value;

  // Update the text content
  document.getElementById(`${entityType}-name-${entityId}`).textContent = newValue;

  // Reset visibility
  document.getElementById(`${entityType}-name-${entityId}`).style.display = "inline-block";
  document.getElementById(`edit-btn-${entityType}-${entityId}`).style.display = "flex";
  document.getElementById(`edit-form-${entityType}-${entityId}`).classList.add("hidden");

  // Optional: Send an update request to the server via fetch or AJAX
  // Example:
  // fetch(`/update-${entityType}/${entityId}`, {
  //   method: 'POST',
  //   headers: { 'Content-Type': 'application/json' },
  //   body: JSON.stringify({ name: newValue }),
  // });
}

function cancelEdit(entityId, entityType) {
  // Reset visibility
  document.getElementById(`${entityType}-name-${entityId}`).style.display = "inline-block";
  document.getElementById(`edit-btn-${entityType}-${entityId}`).style.display = "flex";
  document.getElementById(`edit-form-${entityType}-${entityId}`).classList.add("hidden");
}


//Hàm xử lí categories
function showAddInputForm(catId) {
    const details = document.querySelector(`details[cat-id="${catId}"]`);
    const form = document.getElementById(`add-form-cat-${catId}`);
    
    if (details && !details.open) {
        details.open = true; // Mở tag <details>
    }

    form.classList.remove('hidden'); // Hiển thị form
}

function confirmAdd(catId) {
    const input = document.getElementById(`add-input-cat-${catId}`);
    const newValue = input.value.trim();

    if (newValue) {
        alert(`New sub-category "${newValue}" added for category ID: ${catId}`);
        // Logic gửi dữ liệu đến server ở đây (AJAX hoặc fetch API)
    } else {
        alert('Please enter a valid sub-category name.');
    }

    cancelAdd(catId); // Ẩn form sau khi xử lý
}

function cancelAdd(catId) {
    const form = document.getElementById(`add-form-cat-${catId}`);
    const input = document.getElementById(`add-input-cat-${catId}`);

    form.classList.add('hidden'); // Ẩn form
    input.value = ''; // Reset input
}

//Hàm dùng để xử lí nút delete
function confirmDelete(catId) {
    const modal = document.getElementById('delete-modal');
    const confirmButton = document.getElementById('confirm-btn');

    // Hiển thị modal
    modal.style.display = 'flex';

    // Gắn sự kiện xóa vào nút Confirm
    confirmButton.onclick = () => {
        fetch(`./delete/${catId}`, { method: 'DELETE' })
            .then((response) => {
                if (response.ok) {
                    location.reload(); // Reload trang sau khi xóa thành công
                } else {
                    alert('Xóa thất bại!');
                }
            })
            .catch((error) => console.error('Error:', error));
    };
}

function closeModal() {
    const modal = document.getElementById('delete-modal');
    modal.style.display = 'none';
}
</script>